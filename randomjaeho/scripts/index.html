<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>랜덤재호</title>
    <link rel="stylesheet" href="styles/main.css">
    <!-- 파비콘 추가 -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- iOS 및 iPadOS 홈 화면 아이콘 추가 -->
    <!-- 180x180 픽셀 크기의 'apple-touch-icon.png' 파일을 프로젝트 루트에 추가해주세요. -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
</head>
<body>
    <audio id="bgMusic" src="assets/audio/bgm.mp3" loop></audio>
    <audio id="coinClickSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YQAAAAA="></audio>
    <audio id="spaceBgm" src="assets/audio/bgm.mp3" loop></audio>
    
    <div class="screen-flash" id="screenFlash"></div>

    <div class="game-container" id="gameContainer">
        <!-- 유저 정보 및 로그인/로그아웃 버튼 -->
        <div class="auth-container" id="authContainer">
            <div id="userProfile" class="user-profile" style="display: none;"></div>
            <button id="loginButton" class="login-button">Google로 로그인</button>
            <button id="logoutButton" class="logout-button" style="display: none;">로그아웃</button>
        </div>

        <h1>🎁 랜덤재호</h1>
        
        <!-- 재호코인 표시 영역 -->
        <div class="coins-display" id="coinsDisplay">
            <div class="coin-icon">
                <img src="assets/images/jaeho.jpg" alt="재호코인 아이콘">
            </div>
            <div class="coin-amount" id="coinAmount">0</div>
            <div class="coin-label">재호코인</div>
        </div>
        
        <div class="gacha-container">
            <div class="gacha-box" id="gachaBox" onclick="pullGacha()">📦</div>
            <p style="font-size: 1.2em; opacity: 0.8;">상자를 클릭하여 뽑기!</p>
            
            <div class="result-container" id="resultContainer">
                <img id="resultImage" class="result-image" src="" alt="결과 이미지">
                <div id="resultText" class="result-text"></div>
                <div id="resultGrade" class="result-grade"></div>
            </div>
        </div>

        <!-- 인벤토리 영역 -->
        <div class="inventory-container">
            <div class="inventory-header">
                <h3 id="inventoryTitle">🎒 인벤토리 (0/5)</h3>
            </div>
            <div class="inventory-slots" id="inventorySlots">
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div class="button-container">
            <button class="pull-button" id="pullButton" onclick="pullGacha()">🎲 가챠 뽑기</button>
            <div class="sub-buttons">
                <button class="reset-button" onclick="resetGame()">🔄 초기화</button>
                <button class="save-button" onclick="manualSave()">💾 저장하기</button>
            </div>
            <div class="last-saved-time" id="lastSavedTime"></div>
        </div>

        <div class="probability-info">
            <h3>📊 등급별 확률 & 재호코인</h3>
            <div class="grade-info transcendence" data-grade="transcendence">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color transcendence"></div>
                    <span>초월 (Transcendence)</span>
                </div>
                <span id="prob-display-transcendence">0.05% | 50,000코인</span>
            </div>
            <div class="grade-info ancient" data-grade="ancient">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color ancient"></div>
                    <span>만원</span>
                </div>
                <span id="prob-display-ancient">0.005% | 25,000코인</span>
            </div>
            <div class="grade-info ultimate-jaeho" data-grade="ultimate-jaeho">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color ultimate-jaeho"></div>
                    <span>얼티밋 재호 (Ultimate Jaeho)</span>
                </div>
                <span id="prob-display-ultimate-jaeho">0.01% | 10,000코인</span>
            </div>
            <div class="grade-info divine" data-grade="divine">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color divine"></div>
                    <span>신성 (Divine)</span>
                </div>
                <span id="prob-display-divine">0.1% | 5,000코인</span>
            </div>
            <div class="grade-info cosmic" data-grade="cosmic">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color cosmic"></div>
                    <span class="stars-bg"></span>
                    <span class="stars-bg"></span>
                    <span>우주 (Cosmic)</span>
                </div>
                <span id="prob-display-cosmic">0.5% | 3,000코인</span>
            </div>
            <div class="grade-info mythic" data-grade="mythic">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color mythic"></div>
                    <span>신화 (Mythic)</span>
                </div>
                <span id="prob-display-mythic">1% | 1,000코인</span>
            </div>
            <div class="grade-info legendary" data-grade="legendary">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color legendary"></div>
                    <span>레전드리 (Legendary)</span>
                </div>
                <span id="prob-display-legendary">3% | 500코인</span>
            </div>
            <div class="grade-info" data-grade="epic">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color epic"></div>
                    <span>에픽 (Epic)</span>
                </div>
                <span id="prob-display-epic">7% | 100코인</span>
            </div>
            <div class="grade-info" data-grade="rare">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color rare"></div>
                    <span>레어 (Rare)</span>
                </div>
                <span id="prob-display-rare">12% | 50코인</span>
            </div>
            <div class="grade-info" data-grade="uncommon">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color uncommon"></div>
                    <span>언커먼 (Uncommon)</span>
                </div>
                <span id="prob-display-uncommon">34.5% | 20코인</span>
            </div>
            <div class="grade-info" data-grade="common">
                <div style="display: flex; align-items: center;">
                    <div class="grade-color common"></div>
                    <span>커먼 (Common)</span>
                </div>
                <span id="prob-display-common">41.385% | 10코인</span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalSpins">0</div>
                <div>총 뽑기</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="transcendenceCount">0</div>
                <div>초월</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="ultimateJaehoCount">0</div>
                <div>얼티밋 재호</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="ancientCount">0</div>
                <div>만원</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="divineCount">0</div>
                <div>신성</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="cosmicCount">0</div>
                <div>우주</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="mythicCount">0</div>
                <div>신화</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="legendaryCount">0</div>
                <div>레전드리</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="epicCount">0</div>
                <div>에픽</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="rareCount">0</div>
                <div>레어</div>
            </div>
        </div>

        <!-- 설정 UI -->
        <div class="settings-container">
            <h3>⚙️ 설정</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="musicToggle">🎶 배경 음악</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="musicToggle">
                        <label for="musicToggle" class="toggle-label"></label>
                    </div>
                </div>
                <div class="setting-item">
                    <label for="animationToggle">✨ 애니메이션 효과</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="animationToggle" checked>
                        <label for="animationToggle" class="toggle-label"></label>
                    </div>
                </div>
                <div class="setting-item">
                    <label for="saveNotificationToggle">☁️ 저장 알림</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="saveNotificationToggle" checked>
                        <label for="saveNotificationToggle" class="toggle-label"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="scripts/gameData.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/antiCheat.js"></script>
    <script src="scripts/gacha.js"></script>
    <script src="scripts/effects.js"></script>
    <script src="scripts/quiz.js"></script>
    <script src="scripts/main.js"></script>
    <script src="scripts/firebase.js"></script>

    <!-- 플로팅 버튼 컨테이너 -->
    <div class="floating-buttons-container">
        <button class="floating-button shop-button" onclick="toggleShop()">🏪 상점</button>
        <button class="floating-button fusion-button" onclick="toggleFusionModal()">🛠️ 합성소</button>
        <div class="floating-button cosmic-space-container" id="cosmicSpaceContainer">
            <div class="cosmic-space-overlay">
                <span id="cosmicLockIcon" class="cosmic-space-lock-icon">🔒</span>
                <span id="cosmicSpaceLabel">우주 공간</span>
            </div>
        </div>
    </div>    
</div>

<!-- 상점 모달 (body 끝 부분 근처에 추가) -->
<div class="shop-modal" id="shopModal">
    <div class="shop-content">
        <div class="shop-header">
            <h2>🏪 재호 상점</h2>
            <button class="close-shop" onclick="toggleShop()">✕</button>
        </div>
        
        <!-- 현재 활성 효과 표시 -->
        <div class="active-effects" id="activeEffects">
            <h3>🎯 활성 효과</h3>
            <div class="effects-list" id="effectsList">
                <p class="no-effects">활성 효과가 없습니다</p>
            </div>
        </div>
        
        <!-- 상점 아이템들 -->
        <div class="shop-items">
            <div class="shop-item" data-item="speedPotion">
                <div class="item-icon">⚡</div>
                <div class="item-info">
                    <h4>신속 포션</h4>
                    <p>다음 5회 뽑기 애니메이션 시간 절반</p>
                    <div class="item-price">💰 200 코인</div>
                </div>
                <button class="buy-button" onclick="buyItem('speedPotion')">구매</button>
            </div>
            
            <div class="shop-item" data-item="coinPotion">
                <div class="item-icon">💰</div>
                <div class="item-info">
                    <h4>골드 포션</h4>
                    <p>다음 5회 뽑기에서 골드 획득 2배</p>
                    <div class="item-price">💰 700 코인</div>
                </div>
                <button class="buy-button" onclick="buyItem('coinPotion')">구매</button>
            </div>
            <div class="shop-item" data-item="superSpeedPotion">
                <div class="item-icon">⚡✨</div>
                <div class="item-info">
                    <h4>슈퍼 신속 포션</h4>
                    <p>다음 10회 뽑기 애니메이션 시간 1/3</p>
                    <div class="item-price">💰 800 코인</div>
                </div>
                <button class="buy-button" onclick="buyItem('superSpeedPotion')">구매</button>
            </div>
        </div>
    </div>
</div>

<!-- 등급별 이미지 미리보기 모달 -->
<div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-content">
        <div class="image-preview-header">
            <h3 id="previewGradeName"></h3>
            <button class="close-preview" id="closePreviewModal">✕</button>
        </div>
        <div class="image-preview-grid" id="imagePreviewGrid">
            <!-- 이미지가 여기에 동적으로 추가됩니다. -->
        </div>
    </div>
</div>

<!-- 획득 아이템 선택 모달 -->
<div class="choice-modal" id="choiceModal">
    <div class="choice-content">
        <h2>새로운 재호를 획득했습니다!</h2>
        <div class="choice-item-display">
            <img id="choiceImage" src="" alt="획득한 재호">
            <p id="choiceGradeText"></p>
            <p id="choiceItemName" class="choice-item-name"></p>
        </div>
        <div class="choice-buttons">
            <button id="keepButton">🎒 인벤토리에 넣기</button>
            <button id="discardButton">💰 코인으로 바꾸기</button>
        </div>
    </div>
</div>

<!-- 우주 공간 뽑기 모달 -->
<div class="cosmic-gacha-modal" id="cosmicGachaModal">
    <div class="cosmic-gacha-content">
        <button class="back-button" id="exitCosmicSpaceButton">🌌 돌아가기</button>

        <!-- 신규: 우주 파편 및 행운 강화 UI -->
        <div class="cosmic-top-ui">
            <div class="cosmic-currency-display">
                <span class="cosmic-currency-icon">💠</span>
                <span id="cosmicFragmentsAmount">0</span>
                <span>코즈믹 파편</span>
            </div>
            <div class="permanent-luck-container">
                <h4>✨ 영구 행운 강화</h4>
                <p>현재 레벨: <span id="permanentLuckLevel">0</span></p>
                <p>효과: 상위 등급 확률 영구 증가</p>
                <button id="upgradeLuckButton" class="buy-button">강화 (비용: <span id="luckUpgradeCost">10</span>💠)</button>
            </div>
        </div>

        <!-- 미니게임 컨테이너 -->
        <div class="cosmic-minigame-container">
            <!-- 게임 소개 화면 -->
            <div id="cosmicGameIntro">
                <h1>✨ 코즈믹 시그널</h1>
                <p>우주에서 오는 신호의 순서를 기억하고 그대로 따라 입력하세요. 레벨 5를 클리어하면 보상을 획득합니다!</p>
                <button id="startCosmicGameButton" class="pull-button">게임 시작</button>
            </div>

            <!-- 게임 진행 화면 -->
            <div id="cosmicGameArea" style="display: none;">
                <div id="cosmicGameUI">
                    <span>레벨: <span id="cosmicGameLevel">1</span></span>
                    <span id="cosmicGameStatus">신호를 기억하세요...</span>
                </div>
                <div id="cosmicSignalPad">
                    <div class="signal-button" data-id="0"></div>
                    <div class="signal-button" data-id="1"></div>
                    <div class="signal-button" data-id="2"></div>
                    <div class="signal-button" data-id="3"></div>
                </div>
            </div>

            <!-- 게임 결과 화면 -->
            <div id="cosmicGameResult" style="display: none;">
                <h2 id="cosmicGameResultTitle">게임 종료</h2>
                <p id="cosmicGameResultMessage">결과 메시지</p>
                <button id="restartCosmicGameButton" class="pull-button">다시하기</button>
            </div>
        </div>
    </div>
</div>

<!-- 재호 합성소 모달 -->
<div class="fusion-modal" id="fusionModal">
    <div class="fusion-content">
        <div class="fusion-header">
            <h2>🛠️ 재호 합성소</h2>
            <button class="close-fusion" onclick="toggleFusionModal()">✕</button>
        </div>
        <div class="fusion-main">
            <div class="fusion-slots-container">
                <h4>조합할 재호 (같은 등급 3개)</h4>
                <div class="fusion-slots" id="fusionSlots">
                    <div class="fusion-slot" data-slot-index="0"></div>
                    <div class="fusion-slot" data-slot-index="1"></div>
                    <div class="fusion-slot" data-slot-index="2"></div>
                </div>
                <div class="fusion-arrow">⬇️</div>
                <div class="fusion-result">
                    <div id="fusionResultSlot" class="fusion-slot result"></div>
                </div>
                <button id="fuseButton" class="fuse-button" disabled>합성하기</button>
            </div>
            <div class="fusion-inventory-container">
                <h4>내 인벤토리</h4>
                <div class="fusion-inventory-grid" id="fusionInventoryGrid">
                    <!-- 인벤토리 아이템이 여기에 표시됩니다. -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 닉네임 입력 모달 -->
<div class="nickname-modal" id="nicknameModal">
    <div class="nickname-content">
        <h2>환영합니다!</h2>
        <button class="close-modal-button" onclick="closeNicknameModal()">✕</button>
        <p>게임에서 사용할 "실명(진짜 이름)을 입력해 주세요. (안하면 누군지 몰라서 이벤트때 못뿌림)".</p>
        <input type="text" id="nicknameInput" placeholder="닉네임 (2~10자)" maxlength="10" minlength="2">
        <p id="nicknameError" class="error-message"></p>
        <button id="saveNicknameButton">저장하고 시작하기</button>
    </div>
</div>

</body>
</html>